'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.NanowireError=exports.SpotlightWriter=undefined;var _spotlightJsonLogger=require('spotlight-json-logger');var _spotlightJsonLogger2=_interopRequireDefault(_spotlightJsonLogger);var _raven=require('raven');var _raven2=_interopRequireDefault(_raven);var _requestPromiseNative=require('request-promise-native');var _requestPromiseNative2=_interopRequireDefault(_requestPromiseNative);var _fsExtra=require('fs-extra');var _fsExtra2=_interopRequireDefault(_fsExtra);var _checkEnvExistence=require('./helpers/utils/checkEnvExistence');var _checkEnvExistence2=_interopRequireDefault(_checkEnvExistence);var _sleep=require('./helpers/utils/sleep');var _sleep2=_interopRequireDefault(_sleep);var _downloadAndExtractCache=require('./helpers/caches/downloadAndExtractCache');var _downloadAndExtractCache2=_interopRequireDefault(_downloadAndExtractCache);var _writer=require('./writer');var _writer2=_interopRequireDefault(_writer);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}/* eslint-disable no-undef-init */class SpotlightPipeline{constructor(params){['CONTROLLER_BASE_URI','POD_NAME','PLUGIN_ID'].map(_checkEnvExistence2.default);if(!params)throw new Error('Please supply a params object.');if(!params.taskHandler&&!params.groupHandler){throw new Error('Please supply a taskHandler or a groupHandler function.');}this.taskHandler=params.taskHandler;this.groupHandler=params.groupHandler;_raven2.default.config(process.env.SENTRY_DSN||false,{tags:{pluginName:params.pluginName},captureUnhandledRejections:true}).install();this.pluginId=process.env.PLUGIN_ID;this.podName=process.env.POD_NAME;this.controllerBaseURI=process.env.CONTROLLER_BASE_URI;this.getTaskURI=`${this.controllerBaseURI}/v1/tasks`;this.getTaskURI+=`?pluginId=${this.pluginId}`;this.getTaskURI+=`&pluginInstance=${this.podName}`;this.task=false;}start(){this.processTask();return true;}async processTask(){let task=undefined;try{task=await this._getTask();}catch(e){task=false;}if(!task){await(0,_sleep2.default)(1000);this.processTask();return false;}this.task=task;const{metadata:{job:{workflow:{type}}}}=task;try{if(type==='GROUP'){await this._handleGroup();}else if(type==='SINGLE_FILE'){await this._handleSingleFile();}}catch(e){_spotlightJsonLogger2.default.error('Unknown error occurred handling task.');}this.processTask();return true;}async _getTask(){try{const task=await(0,_requestPromiseNative2.default)({method:'GET',uri:this.getTaskURI,json:true});return task;}catch(e){if(e.statusCode===404){return false;}_spotlightJsonLogger2.default.error('Unknown error getting task');_raven2.default.captureException(e);if(process.env.DEBUG)console.error(e);throw e;}}async _handleGroup(){const{cacheURL}=this.task.metadata.task.metadata;let cachePath=false;if(cacheURL){try{cachePath=await(0,_downloadAndExtractCache2.default)(cacheURL);}catch(e){_spotlightJsonLogger2.default.error('Unknown error downloading cache...');_raven2.default.captureException(e);if(process.env.DEBUG)console.error(e);throw e;}}let additionalMetadata=undefined;let status='success';let error=undefined;try{const result=await this.groupHandler(this.task.metadata,cachePath);if(result){additionalMetadata=result;}}catch(e){_spotlightJsonLogger2.default.error('Error occurred in groupHandler function.');_raven2.default.captureException(e);if(process.env.DEBUG)console.error(e);status='failure';error=e.message||'An unknown error occured';}const payload={pluginInstance:this.podName,status,error,additionalMetadata};try{await _fsExtra2.default.remove('/caches/jsonlds');await _fsExtra2.default.remove('/caches/cache.tar.gz');}catch(e){_spotlightJsonLogger2.default.error('Error removing caches, continuing anyway...');console.error(e);_raven2.default.captureException(e);}return this._updateResults(payload);}async _handleSingleFile(){let jsonld=undefined;let status='success';let error=undefined;try{jsonld=await this.taskHandler(this.task.metadata,this.task.jsonld,this.task.url);}catch(e){_spotlightJsonLogger2.default.error('Error occurred in taskHandler function.');_raven2.default.captureException(e);if(process.env.DEBUG)console.error(e);status='failure';error=e.message||'An unknown error occured';}const payload={pluginInstance:this.podName,status,jsonld,error};return this._updateResults(payload);}async _updateResults(payload){try{const taskId=this.task.metadata.task._id;await(0,_requestPromiseNative2.default)({method:'PUT',uri:`${this.controllerBaseURI}/v1/tasks/${taskId}`,json:true,body:payload});return true;}catch(e){_spotlightJsonLogger2.default.error('Unknown error occurred publishing results.');_raven2.default.captureException(e);if(process.env.DEBUG)console.error(e);throw e;}}}exports.default=SpotlightPipeline;class SpotlightWriter extends _writer2.default{}exports.SpotlightWriter=SpotlightWriter;class NanowireError extends Error{constructor(type,code,...params){super(...params);if(Error.captureStackTrace){Error.captureStackTrace(this,NanowireError);}this.type=type;this.code=code;}}exports.NanowireError=NanowireError;